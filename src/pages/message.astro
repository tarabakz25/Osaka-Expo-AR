---
import Layout from "../layouts/Layout.astro";
import { projects } from '../data/projects.js';
import '../styles/global.css';
import '../styles/message.css';
---

<Layout>
    <div id="particles-js" class="particles-container"></div>
    <div class="message-container">
        <h2 class="message-title">ご視聴ありがとうございました！良ければ、学生にメッセージをお願いいたします。</h2>
        
        <form id="messageForm" class="message-form">
            <div class="form-group">
                <label for="name">お名前（ニックネーム）</label>
                <input type="text" id="name" name="name" class="form-input" placeholder="お名前を入力">
            </div>
            
            <div class="form-project-name">
                <label for="projectName">見たプロジェクト</label>
                <select id="projectName" name="projectName" class="form-select" required>
                    <option value="" disabled selected>プロジェクトを選択してください</option>
                    {projects.map((project, index) => (
                        <option value={index}>{project.name} - {project.keyword}</option>
                    ))}
                </select>
            </div>
            <div class="form-group">
                <label for="message">メッセージ</label>
                <textarea id="message" name="message" rows="5" required class="form-textarea" placeholder="メッセージを入力"></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="submit-button">送信する</button>
                <a href="/" class="back-button">トップに戻る</a>
            </div>
        </form>
        
        <div id="thankYouMessage" class="thank-you-message" style="display: none;">
            <h2>メッセージを送信しました！</h2>
            <p>ご参加いただきありがとうございます。</p>
            <a href="/" class="back-button">トップに戻る</a>
        </div>
    </div>
</Layout>

<script is:inline src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
    // まず必要なデータを取得
    const projectsData = [
        {
            name: "松井ひなこ",
            romaji: "MATSUI HINAKO",
            keyword: "パフェに甘えて",
            dir: "pafe"
        },
        {
            name: "林美羽",
            romaji: "HAYASHI MIU",
            keyword: "わかめプロジェクト",
            dir: "wakame"
        },
        {
            name: "花火",
            romaji: "HANABI",
            keyword: "FRCロボコン",
            dir: "hanabi"
        }
    ];
    
    window.onload = function() {
        // パーティクルJS初期化
        particlesJS("particles-js", {
          "particles": {
            "number": {
              "value": 100,
              "density": {
                "enable": true,
                "value_area": 800
              }
            },
            "color": {
              "value": "#A5DFFF"
            },
            "shape": {
              "type": "circle",
              "stroke": {
                "width": 0,
                "color": "#A5DFFF"
              }
            },
            "opacity": {
              "value": 0.8,
              "random": true
            },
            "size": {
              "value": 5,
              "random": true
            },
            "line_linked": {
              "enable": false,
              "distance": 150,
              "color": "#888888",
              "opacity": 0.6,
              "width": 1
            },
            "move": {
              "enable": true,
              "speed": 1,
              "direction": "top",
              "random": true,
              "straight": false
            }
          },
          "interactivity": {
            "detect_on": "canvas",
            "events": {
              "onhover": {
                "enable": true,
                "mode": "repulse"
              },
              "onclick": {
                "enable": true,
                "mode": "push"
              },
              "resize": true
            }
          },
          "retina_detect": true
        });
        
        // セッションストレージから選択されたプロジェクトを取得
        const selectedProjectIndex = sessionStorage.getItem('selectedProject');
        const projectNameSelect = document.getElementById('projectName');
        const messageForm = document.getElementById('messageForm');
        const thankYouMessage = document.getElementById('thankYouMessage');
        
        console.log("選択されたプロジェクトインデックス:", selectedProjectIndex);
        
        // セッションストレージに保存されたプロジェクトがあれば、そのプロジェクトを選択状態にする
        if (selectedProjectIndex !== null && projectsData[selectedProjectIndex]) {
            projectNameSelect.value = selectedProjectIndex;
        }
        
        // フォーム送信イベントの処理
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(messageForm);
            const selectedProjectIndex = formData.get('projectName'); // selectから選択されたプロジェクトのインデックス
            
            const data = {
                projectIndex: selectedProjectIndex,
                name: formData.get('name'),
                message: formData.get('message'),
                timestamp: new Date().toISOString()
            };
            
            try {
                const response = await fetch('/api/save-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    // 送信成功メッセージを表示
                    messageForm.style.display = 'none';
                    thankYouMessage.style.display = 'block';
                } else {
                    const errorData = await response.json();
                    alert(`メッセージの送信に失敗しました: ${errorData.error || '不明なエラー'}`);
                }
            } catch (error) {
                console.error('エラーが発生しました:', error);
                alert('エラーが発生しました。もう一度お試しください。');
            }
        });
    };
</script>
