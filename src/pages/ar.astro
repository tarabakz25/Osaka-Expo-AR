---
import { Image } from "astro:assets"
import ARLayout from '../layouts/ARLayout.astro';
import MarkerAnnounce from '../assets/marker-announce.svg';
import { projects } from '../data/projects.js';
import '../styles/ar.css';
---

<ARLayout>    
    <script is:inline src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script is:inline src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <div id="arjsContent">
        <!-- ★ 開始を促すオーバーレイを追加 -->
        <div id="startOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 100; text-align: center; flex-direction: column; font-size: 1.2em; cursor: pointer;">
            <p>ARを開始するには</p>
            <p>画面をタップしてください</p>
        </div>

        <!-- マーカー案内画像 -->
        <div id="markerGuide">
            <div class="marker-image-container">
                <Image src={MarkerAnnounce} alt="マーカー案内" width="300" height="300" />
            </div>
        </div>
    
        <!-- デバッグ情報表示エリア -->
        <!-- <div id="debugInfo" style="position: fixed; top: 10px; left: 10px; background-color: rgba(0,0,0,0.7); color: white; padding: 10px; z-index: 9999; border-radius: 5px; width: 80%; max-width: 300px;">
            <h3 style="margin: 0 0 5px 0; font-size: 14px;">デバッグ情報</h3>
            <div>マーカー状態: <span id="markerStatus">未検出</span></div>
            <div>現在のプロジェクト: <span id="currentProject">なし</span></div>
            <div>テキスト読込: <span id="textLoadStatus">未読込</span></div>
            <div>動画読込: <span id="videoLoadStatus">未読込</span></div>
            <div id="errorMessage" style="color: #ff6b6b;"></div>
        </div> -->
        
        <!-- 動画再生後のお礼メッセージ -->
        <div id="thankYouContainer">
            <h2>ご視聴ありがとうございました！</h2>
            <p>学生の作品はいかがでしたか？</p>
            <p>良ければ、学生へのメッセージをお願いします。</p>
            <a href="/message" id="messageButton">Send Message!</a>
            <div class="project-selection">
                <p>他の作品も見ますか？</p>
                <select id="projectSelector">
                    {projects.map((project, index) => (
                        <option value={index}>{project.name} - {project.keyword}</option>
                    ))}
                </select>
                <button id="watchAgainButton">Start!</button>
            </div>
        </div>
        
        <div id="arjs-scene">
            <a-scene
                vr-mode-ui="enabled: false;"
                renderer="logarithmicDepthBuffer: true; precision: medium;"
                embedded
                arjs="trackingMethod: best; sourceType: webcam;">
                
                <!-- アセット管理システム -->
                <a-assets>
                    <video id="projectVideo" src="" loop="false" playsinline></video>
                </a-assets>

                <a-marker type="pattern" url='/pattern-test.patt' id="patternMarker">
                    <a-entity
                        id="projectText"
                        scale="2 2 2"
                        position="2 2 0"
                        text="value: テスト表示; align: center; width: 2; color: white; background-color: rgba(0,0,0,0.8); wrapCount: 20;"
                        visible="true">
                    </a-entity>
                    <a-video
                        id="projectVideoEntity"
                        width="6"
                        height="2"
                        position="-1 0 0"
                        rotation="-45 0 0"
                        src="#projectVideo"
                        visible="false"
                        opacity="0"
                        playsinline>
                    </a-video>
                </a-marker>
                <!-- カメラ -->
                <a-entity camera></a-entity>
            </a-scene>
        </div>
        
        <!-- 位置調整ガイド -->

        <div class="position-guide">
            <h2>マネキン上のマーカーを写して見てください！</h2>
            <p>画面で動画の左右の位置を調節できます。<br>動画が大きすぎる時は、少し離れて見て見てください。</p>
        </div>
    </div>
</ARLayout>

<script define:vars={{ projects }}>
    document.addEventListener('DOMContentLoaded', () => {
        const marker = document.getElementById('patternMarker');
        const projectVideo = document.getElementById('projectVideo');
        const projectVideoEntity = document.getElementById('projectVideoEntity');
        const projectText = document.getElementById('projectText');
        const markerStatus = document.getElementById('markerStatus');
        const currentProject = document.getElementById('currentProject');
        const textLoadStatus = document.getElementById('textLoadStatus');
        const videoLoadStatus = document.getElementById('videoLoadStatus');
        const thankYouContainer = document.getElementById('thankYouContainer');
        const errorMessage = document.getElementById('errorMessage');
        const startOverlay = document.getElementById('startOverlay');
        const markerGuide = document.getElementById('markerGuide');
        const sceneEl = document.querySelector('a-scene');
        
        let canPlayVideo = false;
        let userInteracted = false;

        // マーカー検出のイベントハンドラを変数に格納
        const markerFoundHandler = () => {
            if (markerStatus) markerStatus.textContent = '検出中';
            if (markerGuide) {
                markerGuide.style.display = 'none';
            }

            if (canPlayVideo) {
                projectVideoEntity.setAttribute('visible', 'true');
                projectVideoEntity.setAttribute('animation', {
                    property: 'opacity',
                    from: 0,
                    to: 1, 
                    dur: 1000,
                    easing: 'easeOutCubic'
                });
                projectVideo.play().catch(e => console.error("Video play error after marker found:", e));
                console.log('Marker found, attempting to play video.');
            } else {
                console.log('Marker found, but video cannot play yet.');
                if (!canPlayVideo) console.log('Reason: Video not ready (canPlayVideo=false)');
                if (errorMessage) errorMessage.textContent = '動画の準備ができていません。';
            }
        };

        const markerLostHandler = () => {
            if (markerStatus) markerStatus.textContent = '消失';
            if (projectVideo) {
                projectVideo.pause();
                projectVideoEntity.setAttribute('animation', {
                    property: 'opacity',
                    from: 1,
                    to: 0, 
                    dur: 500,
                    easing: 'easeInCubic',
                    onComplete: () => projectVideoEntity.setAttribute('visible', 'false')
                });
            }
            if (markerGuide) {
                markerGuide.style.display = 'flex';
            }
        };

        startOverlay.addEventListener('click', () => {
            userInteracted = true;
            startOverlay.style.display = 'none';

            // マーカー読み取り案内を1秒後にディゾルブで表示
            setTimeout(() => {
                if (markerGuide) {
                    markerGuide.style.display = 'flex';
                    setTimeout(() => {
                        markerGuide.style.opacity = '1';
                    }, 50);
                }
            }, 1500);

            marker.addEventListener('markerFound', markerFoundHandler);
            marker.addEventListener('markerLost', markerLostHandler);

            if (selectedProject && selectedProject.dir) {
                const playPromise = projectVideo.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        projectVideo.pause();
                        projectVideo.currentTime = 0;
                        console.log("User interaction registered. Ready for audio playback.");
                    }).catch(error => {
                        console.warn("Initial muted play attempt failed, but interaction registered.", error);
                    });
                }
            }

            if (sceneEl && !sceneEl.hasLoaded) {
                 console.log('A-Frame scene not loaded yet, user interaction occurred.');
            }

        }, { once: true });

        const selectedProjectIndex = sessionStorage.getItem('selectedProject') || 0;
        const selectedProject = projects[selectedProjectIndex];
        
        if (currentProject) {
            currentProject.textContent = selectedProject ? `${selectedProject.name} - ${selectedProject.keyword}` : 'なし';
        }
        
        if (selectedProject) {
            projectText.setAttribute('text', {
                value: `${selectedProject.name}\n${selectedProject.keyword}`,
                align: 'center',
                width: 5,
                color: 'black'
            });
            if (textLoadStatus) textLoadStatus.textContent = '読込完了';
        } else {
            if (textLoadStatus) textLoadStatus.textContent = 'エラー';
        }

        if (selectedProject && selectedProject.dir) {
            const videoPath = `/items/${selectedProject.dir}/movie.mov`;
            projectVideo.src = videoPath;
            if (videoLoadStatus) videoLoadStatus.textContent = '準備中...';
            
            projectVideo.onloadeddata = () => {
                if (videoLoadStatus) videoLoadStatus.textContent = 'データ読込完了';
            };
            
            projectVideo.oncanplay = () => {
                if (videoLoadStatus) videoLoadStatus.textContent = '再生準備完了';
                canPlayVideo = true;
            };
            
            projectVideo.onerror = (e) => {
                console.error(`動画(${videoPath})の読み込み/再生エラー:`, e);
                console.error('エラーオブジェクト:', projectVideo.error);

                if (videoLoadStatus) videoLoadStatus.textContent = `読込失敗 (${projectVideo.error?.code || 'unknown'})`;
                if (errorMessage) errorMessage.textContent = `動画(${videoPath})の読み込みに失敗しました。詳細: ${projectVideo.error?.message || '不明なエラー'}`;
            };
            projectVideo.load();
        } else {
            if (errorMessage) errorMessage.textContent = '選択されたプロジェクト情報が見つかりません。';
            console.error('選択されたプロジェクト情報が見つかりません:', selectedProjectIndex, projects);
            if (videoLoadStatus) videoLoadStatus.textContent = 'エラー';
            if (textLoadStatus) textLoadStatus.textContent = 'エラー';
        }

        projectVideo.addEventListener('ended', () => {
            // ARマーカー検知を停止するためにイベントリスナーを削除
            marker.removeEventListener('markerFound', markerFoundHandler);
            marker.removeEventListener('markerLost', markerLostHandler);
            
            // マーカー案内画像を非表示
            if (markerGuide) {
                markerGuide.style.display = 'none';
            }
            
            // お礼メッセージをアニメーションで表示
            thankYouContainer.style.opacity = '0';
            thankYouContainer.style.display = 'block';
            
            // CSSトランジションでフェードイン
            setTimeout(() => {
                thankYouContainer.style.transition = 'opacity 1.5s ease-in-out';
                thankYouContainer.style.opacity = '1';
            }, 100);
            
            sessionStorage.setItem('selectedProject', selectedProjectIndex);
        });

        // 他のプロジェクトを見るための処理
        const projectSelector = document.getElementById('projectSelector');
        const watchAgainButton = document.getElementById('watchAgainButton');
        
        if (projectSelector && watchAgainButton) {
            // 現在選択されているプロジェクトをデフォルト選択に
            projectSelector.value = selectedProjectIndex;
            
            watchAgainButton.addEventListener('click', () => {
                const newProjectIndex = projectSelector.value;
                sessionStorage.setItem('selectedProject', newProjectIndex);
                
                // お礼メッセージを非表示
                thankYouContainer.style.display = 'none';
                
                // マーカーガイドを表示
                if (markerGuide) {
                    markerGuide.style.display = 'flex';
                }
                
                // 再読み込みして新しいプロジェクトの動画を準備
                location.reload();
            });
        }

        const debugElements = [markerStatus, currentProject, textLoadStatus, videoLoadStatus, errorMessage];
        debugElements.forEach(el => {
            if (!el) {
            }
        });
    });
</script>
